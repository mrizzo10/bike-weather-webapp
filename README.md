# Bike Weather Checker

A web application that sends daily personalized bike weather forecasts to subscribers based on their location and riding preferences.

**Live at: [bikeweather.lol](https://bikeweather.lol)**

## Features

- **Personalized forecasts** - Daily 6 AM emails with 5-day bike weather forecast for your location
- **Custom preferences** - Set your own temperature thresholds for dry/rainy conditions and snow tolerance
- **Travel suggestions** - When local weather isn't ideal, see nearby cities with better riding conditions (drive or fly)
- **Settings page** - Update your location and preferences anytime via link in emails
- **One-click unsubscribe** - Easy opt-out from any email

## How It Works

Subscribers set their comfort thresholds:
- **Minimum temperature (no rain)** - Default 33°F
- **Minimum temperature (with rain)** - Default 45°F
- **Snow riding** - Opt-in if you're willing to ride in snow

The app checks weather forecasts and marks time slots as "suitable" if they meet your criteria.

## Tech Stack

- **Flask** - Python web framework
- **PostgreSQL** - Database (hosted on Render)
- **Resend** - Email delivery
- **OpenWeatherMap API** - Weather data

## Environment Variables

| Variable | Description |
|----------|-------------|
| `DATABASE_URL` | PostgreSQL connection string (auto-set by Render) |
| `OPENWEATHER_API_KEY` | Get free at [openweathermap.org/api](https://openweathermap.org/api) |
| `RESEND_API_KEY` | Get at [resend.com](https://resend.com) |
| `EMAIL_FROM` | Sender address (must be verified in Resend) |
| `APP_URL` | Your deployed URL (e.g., `https://bikeweather.lol`) |
| `FLASK_SECRET_KEY` | Random string for session security (auto-generated by Render) |
| `ADMIN_KEY` | Secret key for admin endpoints |

## Local Development

1. Install dependencies:
```bash
pip install -r requirements.txt
```

2. Create a `.env` file with the environment variables above

3. Run the development server:
```bash
python app.py
```

4. Visit http://localhost:5000

## Testing

Run the test suite before deploying:
```bash
python tests.py
```

Tests cover:
- Weather analysis logic (temperature thresholds, precipitation, snow)
- Email generation (content, links, travel section visibility)
- Distance and drive time calculations
- City configuration validation
- Flask routes and form elements

All tests should pass (some may be skipped if no DATABASE_URL is set).

## Deploying to Render

1. Push code to GitHub

2. Go to [render.com](https://render.com) → "New" → "Blueprint"

3. Connect your GitHub repo - Render auto-detects `render.yaml` and creates:
   - Web service (signup page & API)
   - PostgreSQL database
   - Cron job (daily emails at 6 AM EST)

4. Add environment variables in Render dashboard:
   - `OPENWEATHER_API_KEY`
   - `RESEND_API_KEY`
   - `EMAIL_FROM`
   - `APP_URL`
   - `ADMIN_KEY`

5. Deploy!

### Custom Domain

To use a custom domain:
1. Add domain in Render → Settings → Custom Domains
2. Configure DNS (CNAME or ALIAS record pointing to your Render URL)
3. Update `APP_URL` environment variable to your custom domain

## API Endpoints

### Public
- `GET /` - Signup page
- `POST /subscribe` - Create subscription
- `GET /unsubscribe/<token>` - Unsubscribe
- `GET /settings/<token>` - View/update preferences

### Preview & Admin
- `GET /preview?city=Miami&state=FL` - Preview email for any location
  - Optional params: `min_temp_no_precip`, `min_temp_with_precip`, `ride_in_snow`
- `GET /admin/subscribers?key=ADMIN_KEY` - List all subscribers (JSON)
- `GET /admin/delete/<email>?key=ADMIN_KEY` - Delete a subscriber

### Manual Email Trigger
```bash
python app.py send-emails
```

## Database Schema

```sql
subscribers (
  id SERIAL PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  city TEXT NOT NULL,
  state TEXT NOT NULL,
  zip_code TEXT,
  lat REAL NOT NULL,
  lon REAL NOT NULL,
  verified INTEGER DEFAULT 0,
  verification_token TEXT,
  unsubscribe_token TEXT,
  settings_token TEXT,
  min_temp_no_precip INTEGER DEFAULT 33,
  min_temp_with_precip INTEGER DEFAULT 45,
  ride_in_snow INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_email_sent TIMESTAMP
)
```

## License

MIT
